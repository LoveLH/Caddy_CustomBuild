#
# Copyright (C) 2023 Ing <https://github.com/LoveLH>
# 
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#


name: Custom Caddy
on:
  issues:
    types: [opened, reopened]
  workflow_dispatch:
    inputs:
      body: 
        description: 'issuss body'
        required: true
        default: ''
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Create Issues comment
        if: github.event_name == 'issues'
        id: comment
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: | 
            ÂàÜÊûê title Âíå body ÂÜÖÂÆπ ..  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----
          emoji: heart

      - name: Set up Ruby 3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.2

      - name: Set up Python 3
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Set up Go
        uses: actions/setup-go@v3.5.0
        with:
          go-version: '1.20.2'

      - name: Init Env
        run : |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          sudo timedatectl set-timezone "Asia/Shanghai"

          python -m pip install --upgrade pip setuptools
          python -m pip install requests

          go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      - name: Get Issues Info
        if: github.event_name == 'issues'
        id: get-issues
        uses: actions/github-script@v6
        with:
          script: |
            // '<???>': ÊõøÊç¢‰∏ÄÊ¨°; '/<???>/g': ÊõøÊç¢ÂÖ®Â±Ä; '/<???>/gi': ÊõøÊç¢ÂÖ®Â±ÄÂπ∂ÂøΩÁï•Â§ßÂ∞èÂÜô; 
            // \u0008 \b Backspace
            // \u0009 \t Tab
            // \u000A \n Êç¢Ë°åÁ¨¶
            // \u000B \v ÂûÇÁõ¥Âà∂Ë°®Á¨¶
            // \u000C \f Êç¢È°µ
            // \u000D \r ÂõûËΩ¶
            // \u0022 \" ÂèåÂºïÂè∑ (")
            // \u0027 \' ÂçïÂºïÂè∑ (')
            // \u005C \\ ÂèçÊñúÊù† (\)
            // \u00A0    ‰∏çÈó¥Êñ≠Á©∫Ê†º
            // \u2028    Ë°åÂàÜÈöîÁ¨¶
            // \u2029    ÊÆµËêΩÂàÜÈöîÁ¨¶
            // \uFEFF    Â≠óËäÇÈ°∫Â∫èÊ†áËÆ∞

            var fs = require('fs'); // ÂºïÂÖ•fsÊ®°Âùó
            var issuenumber = ${{ toJSON(github.event.issue.number) }};
            var issueauth = ${{ toJSON(github.event.issue.user.login) }};
            var issuetitle = ${{ toJSON(github.event.issue.title) }};
            var issuebody = ${{ toJSON(github.event.issue.body) }};

            if (issuetitle != null) {
              issuetitle = issuetitle.replace(/\u000A|\u000D/g, "");  // Êç¢Ë°åÁ¨¶,ÂõûËΩ¶
            }
            
            if (issuebody != null) {
              // Backspace,Tab,ÂûÇÁõ¥Âà∂Ë°®Á¨¶,Êç¢È°µ,ÂõûËΩ¶,‰∏çÈó¥Êñ≠Á©∫Ê†º,Ë°åÂàÜÈöîÁ¨¶,ÊÆµËêΩÂàÜÈöîÁ¨¶,Â≠óËäÇÈ°∫Â∫èÊ†áËÆ∞
              issuebody = issuebody.replace(/\u0008|\u0009|\u000B|\u000C|\u000D|\u00A0|\u2028|\u2029|\uFEFF/g, "");
              
              // ÂÆπÈîô
              issuebody = issuebody.replace(/Ôºö/g, ": ");
              issuebody = issuebody.replace(/Ôºå/g, ", ");
              issuebody = issuebody.replace(/‚Äú|‚Äù/g, "\"");

              fs.writeFileSync(`body#${issuenumber}.txt`, issuebody, { 'flag': 'w' }, (err) => { if (err) throw err; });
            
              var regex = /\`\`\`([\s\S]*?)\`\`\`/g;
              let options = issuebody.match(regex);
              if (options != null && options.length > 0) {
                fs.writeFileSync('customshell.sh', options[options.length-1].replace(/\`/g, ""), { 'flag': 'w' }, (err) => { if (err) throw err; });
                for(option in options) {
                  console.log(options[option]);
                  issuebody = issuebody.replace(options[option], "");
                }
              }
              // Êç¢Ë°åÁ¨¶
              issuebody = issuebody.replace(/\u000A/g, "");
            }
            core.setOutput("issuenumber", JSON.stringify(issuenumber));
            core.setOutput("issueauth", JSON.stringify(issueauth));
            core.setOutput("issuetitle", JSON.stringify(issuetitle));
            core.setOutput("issuebody", JSON.stringify(issuebody));

      - name: Set Issues Info
        if: github.event_name == 'issues' && success()
        run: |
          echo issuenumber: '${{ steps.get-issues.outputs.issuenumber }}'
          echo issueauth:   '${{ steps.get-issues.outputs.issueauth }}'
          echo issuetitle:  '${{ steps.get-issues.outputs.issuetitle }}'
          echo issuebody:   '${{ steps.get-issues.outputs.issuebody }}'

          echo "issuenumber="${{ steps.get-issues.outputs.issuenumber }}"" >> $GITHUB_ENV
          echo "issueauth="${{ steps.get-issues.outputs.issueauth }}"" >> $GITHUB_ENV
          echo "issuetitle="${{ steps.get-issues.outputs.issuetitle }}"" >> $GITHUB_ENV
          echo "issuebody="${{ steps.get-issues.outputs.issuebody }}"" >> $GITHUB_ENV

          if [ -f 'customshell.sh' ]; then
            echo "customshell.sh"
            cat customshell.sh
          fi

      - name: Get Build Info
        shell: python
        run: |
          # -*- coding: utf-8 -*-
          import os, re, json, shutil, string, requests, subprocess

          def set_output(name, value):
              subprocess.call(["echo '{}={}' >> $GITHUB_ENV".format(name, value)], shell=True)

          if __name__ == '__main__':

              issues = 'false'
              iscustom = 'true'
              errinfo = ''
              warinfo = ''

              GOOS = ''
              GOARCH = ''
              GOARM = ''
              version = ''

              addons = ''



              try:
                  body = {}
                  bodyOriginal = {}
                  if '${{ github.event_name }}' == 'issues':
                      if '${{ env.issuetitle }}'.lower().startswith('custom'):
                          issues = 'true'
                          bodyOriginal = json.loads('${{ env.issuebody }}')
                      else:
                          iscustom = 'false'
                  else:
                      bodyOriginal = json.loads('${{ inputs.body }}')

                  for k, v in bodyOriginal.items():
                    body[k.lower()] = v

                  if len(body) == 0:
                      iscustom = 'false'
                      errinfo = 'body ÈîôËØØ, body is null'
                  else:
                      if 'GOOS' in body: GOOS = body['GOOS'].strip()
                      if 'GOARCH' in body: GOARCH = body['GOARCH'].strip()
                      if 'GOARM' in body: GOARM = body['GOARM'].strip()
                      if 'version' in body: version = body['version'].strip()

                      if 'addons' in body: addons = body['addons'].strip()

              except Exception as e:
                  iscustom = 'false'
                  errinfo = 'body ÈîôËØØ, ‰∏çÁ¨¶ÂêàJSONËßÑËåÉ {}.'.format(e)


              if iscustom == 'true' and addons != '':
                  curAddons = [ x.strip() for x in re.split(',| |\|', addons) if x.strip() != '' ]
                  curAddons = list(set(curAddons))
                  if iscustom == 'true' and addons != '':
                    addons = ' --with '.join(curAddons)

              set_output('issues', issues)
              set_output('iscustom', iscustom)
              set_output('errinfo', errinfo)
              set_output('warinfo', warinfo)

              set_output('GOOS', GOOS)
              set_output('GOARCH', GOARCH)
              set_output('version', version)
              set_output('GOARM', GOARM)

              set_output('addons', addons)

      - name: Echo Build Info
        run: |
          echo issues:            '${{ env.issues }}'
          echo iscustom:          '${{ env.iscustom }}'
          echo errinfo:           '${{ env.errinfo }}'
          echo warinfo:           '${{ env.warinfo }}'

          echo GOOS:        '${{ env.GOOS }}'
          echo GOARCH:             '${{ env.GOARCH }}'
          echo version:           '${{ env.version }}'
          echo GOARM:          '${{ env.GOARM }}'

          echo addons:            '${{ env.addons }}'

      - name: Add Issues labels
        if: env.issues == 'true' && env.iscustom == 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'add-labels'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ env.issuenumber }}
          labels: 'custom,${{ env.model }}'

      - name: Update Comment Begin
        if: env.issues == 'true' && env.iscustom == 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} ÊÇ®Â•Ω.  
            ÊÇ®Ëá™ÂÆö‰πâÁöÑ Caddy Â∑≤ÂºÄÂßãÊûÑÂª∫. ËØ∑ÂâçÂæÄ‰∏ãÈù¢ÁöÑ URL Êü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ.  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----
          emoji: heart

      - name: Update Comment Error
        if: env.issues == 'true' && env.iscustom == 'false'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} ÊÇ®Â•Ω.  
            ÊÇ®Ëá™ÂÆö‰πâ Caddy ÊâÄÂ°´ÂÜôÁöÑ‰ø°ÊÅØÊúâËØØ, Êó†Ê≥ïËß¶ÂèëÁºñËØë, ËØ∑ÂèÇËÄÉÊ®°ÊùøÂíåÈîôËØØÊèêÁ§∫ÂØπbodyËøõË°å‰øÆÊîπÂπ∂ËØ∑ÈáçÊñ∞Ëß¶ÂèëÁºñËØë(Close & Reopen).  
            `Error Info:`  
            `${{ env.errinfo }}`  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----
          emoji: confused

      - name: Update Comment Warinfo
        if: env.issues == 'true' && env.warinfo != ''
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: append
          body: |
            >
            ----
            ‚ÄºÔ∏è‚ÄºÔ∏è‚ÄºÔ∏è 
            `${{ env.warinfo }}`  
            >
            ----
          emoji: eyes

      - name: Update Comment Invalid
        if: env.issues == 'false'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} ÊÇ®Â•Ω.  
            Ê†πÊçÆ title Âíå body ÂÜÖÂÆπÁöÑÂàÜÊûê, ËØ• Issue Âπ∂ÈùûÂÆöÂà∂ Caddy. Â∞ÜÂú®ÁÆ°ÁêÜÂëòÁúãÂà∞Âêé‰ºöËøõË°åÂõûÂ§ç.  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ----
          emoji: eyes

      - name: Run Build
        if: env.iscustom == 'true' && success()
        run: |
          # Á¥Ø‰∫Ü, ÊØÅÁÅ≠Âêß
          #
          # # curl ÂèÇÊï∞ËØ¥Êòé
          # -f, --fail              ËøûÊé•Â§±Ë¥•Êó∂‰∏çÊòæÁ§∫HTTPÈîôËØØ‰ø°ÊÅØ (H)
          # -k, --insecure          ÂÖÅËÆ∏ËøûÊé•Âà∞ SSL Á´ôÁÇπÔºåËÄå‰∏ç‰ΩøÁî®ËØÅ‰π¶ (H)
          # -L, --location          Ë∑üË∏™ÈáçÂÆöÂêë (H)
          # -o, --output FILE       Â∞ÜËæìÂá∫ÂÜôÂÖ•Êñá‰ª∂ÔºåËÄåÈùû stdout
          # -O, --remote-name       Â∞ÜËæìÂá∫ÂÜôÂÖ•ËøúÁ®ãÊñá‰ª∂
          # -S, --show-error        ÊòæÁ§∫ÈîôËØØ. Âú®ÈÄâÈ°π -s ‰∏≠ÔºåÂΩì curl Âá∫Áé∞ÈîôËØØÊó∂Â∞ÜÊòæÁ§∫
          # -s, --silent            SilentÊ®°Âºè„ÄÇ‰∏çËæìÂá∫‰ªªÂä°ÂÜÖÂÆπ
          # -w, --write-out FORMAT  ÂÆåÊàêÂêéËæìÂá∫‰ªÄ‰πà
          # -#/--progress-bar	      Áî®ËøõÂ∫¶Êù°ÊòæÁ§∫ÂΩìÂâçÁöÑ‰º†ÈÄÅÁä∂ÊÄÅ

          sudo apt update

          # ÁºñËØë
          echo "==============================ÁºñËØë=============================="
          xcaddy build  ${{ env.addons }}

      - name: Generate release tag
        if: env.iscustom == 'true' && success()
        id: tag
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV

          if [ ${{ env.issues }} == 'true' ]; then
            echo "### ${{ env.issueauth }}'s Caddy Custom" >> $GITHUB_STEP_SUMMARY
            echo "üëâ issues: [#${{ env.issuenumber }}](${{ github.event.issue.html_url }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ${{ github.triggering_actor }}'s Caddy Custom" >> $GITHUB_STEP_SUMMARY
            echo "üëâ "GOOS": "${{ env.GOOS }}"  " >> $GITHUB_STEP_SUMMARY
            echo "üëâ "GOARCH": "${{ env.GOARCH }}"  " >> $GITHUB_STEP_SUMMARY
            echo "üëâ "GOARM": "${{ env.GOARM }}"  " >> $GITHUB_STEP_SUMMARY
            echo "üëâ "version": "${{ env.version }}"  " >> $GITHUB_STEP_SUMMARY
          fi

          if [ '${{ env.warinfo }}' != '' ]; then
            echo "  " >> $GITHUB_STEP_SUMMARY
            echo "‚ÄºÔ∏è‚ÄºÔ∏è‚ÄºÔ∏è  " >> $GITHUB_STEP_SUMMARY
            echo 'Body ‰∏≠Âê´ÊúâËá™ÂÆö‰πâÁöÑ ${{ env.warinfo }} ÊïèÊÑü‰ø°ÊÅØ, ‰∏∫Èò≤Ê≠¢ÂÖ∂‰ªñ‰∫∫ÁõóÁî®, Âª∫ËÆÆÈôÑ‰ª∂‰∏ãËΩΩÂÆåÊàêÂêéÂà†Èô§Êó•ÂøóÂíåÈôÑ‰ª∂.  ' >> $GITHUB_STEP_SUMMARY
            echo 'Âú®üëâIssues‰∏ãËØÑËÆ∫ "delete builds" Âç≥ÂèØÂà†ËØ•IssuesÁöÑÊâÄÊúâÂéÜÂè≤ÁºñËØëËÆ∞ÂΩï.  ' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload to Artifacts
        if: env.iscustom == 'true' && success()
        uses: actions/upload-artifact@v3
        with:
          name: Caddy-${{ env.GOOS }}-${{ env.version }}-${{ env.release_tag }}
          path: |
            caddy

      - name: Generate release tag
        if: env.iscustom == 'false'
        run: |
          if [ ${{ env.issues }} == 'true' ]; then
            echo "### ${{ env.issueauth }}'s Caddy Custom" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ${{ github.triggering_actor }}'s Caddy Custom" >> $GITHUB_STEP_SUMMARY
          fi
          echo "üòû üòî üòü üòï üôÅ ‚òπÔ∏è üò£ üòñ üò´ üò© ü•∫ üò¢  " >> $GITHUB_STEP_SUMMARY
          echo "ÊÇ®Ëá™ÂÆö‰πâ Caddy ÊâÄÂ°´ÂÜôÁöÑ‰ø°ÊÅØÊúâËØØ, Êó†Ê≥ïËß¶ÂèëÁºñËØë, ËØ∑ÂèÇËÄÉÊ®°ÊùøÂíåÈîôËØØÊèêÁ§∫ÂØπbodyËøõË°å‰øÆÊîπÂπ∂ËØ∑ÈáçÊñ∞Ëß¶ÂèëÁºñËØë(Close & Reopen).  " >> $GITHUB_STEP_SUMMARY
          echo "`Error Info:`  " >> $GITHUB_STEP_SUMMARY
          echo "`${{ env.errinfo }}`  " >> $GITHUB_STEP_SUMMARY
          if [ '${{ env.warinfo }}' != '' ]; then
            echo "  " >> $GITHUB_STEP_SUMMARY
            echo "‚ÄºÔ∏è‚ÄºÔ∏è‚ÄºÔ∏è  " >> $GITHUB_STEP_SUMMARY
            echo 'Body ‰∏≠Âê´ÊúâËá™ÂÆö‰πâÁöÑ ${{ env.warinfo }} ÊïèÊÑü‰ø°ÊÅØ, ‰∏∫Èò≤Ê≠¢ÂÖ∂‰ªñ‰∫∫ÁõóÁî®, Âª∫ËÆÆÁ°ÆËÆ§ÈîôËØØÂéüÂõ†ÂêéÂà†Èô§Êó•ÂøóÂíåÈôÑ‰ª∂.  ' >> $GITHUB_STEP_SUMMARY
            echo 'Âú®üëâIssues‰∏ãËØÑËÆ∫ "delete builds" Âç≥ÂèØÂà†üëâIssuesÁöÑÊâÄÊúâÂéÜÂè≤ÁºñËØëËÆ∞ÂΩï.  ' >> $GITHUB_STEP_SUMMARY
          fi


      - name: Update Comment Finish
        if: env.issues == 'true' && env.iscustom == 'true' && success()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} ÊÇ®Â•Ω.
            ÊÇ®Ëá™ÂÆö‰πâÁöÑ Caddy Â∑≤ÊûÑÂª∫ÂÆåÊàê. ËØ∑ÂâçÂæÄ‰∏ãÈù¢ÁöÑ URL ‰∏ãËΩΩ.  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----  
            PS:  
            Âú®Issues‰∏ãËØÑËÆ∫ "transfer" ÈôÑ‰ª∂ËΩ¨Âø´‰º† üö≤->üèç. (ËØ∑ÂãøÈáçÂ§çÂèë, Êìç‰ΩúÊó∂Èó¥ ‚âà ÊàêÂäü‰∏™Êï∞ X 3ÂàÜÈíü). 
            Âú®Issues‰∏ãËØÑËÆ∫ "delete builds" Âç≥ÂèØÂà†ËØ•IssuesÁöÑÊâÄÊúâÂéÜÂè≤ÁºñËØëËÆ∞ÂΩï.
            >  
            ----  
          emoji: hooray

      - name: Close Issues
        if: env.issues == 'true' && env.iscustom == 'true' && success()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'close-issue'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ env.issuenumber }}

      - name: Update Comment Fail
        if: env.issues == 'true' && env.iscustom == 'true' && failure()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} ÊÇ®Â•Ω.
            ÊÇ®Ëá™ÂÆö‰πâÁöÑ Redpill ÊûÑÂª∫Â§±Ë¥•. ËØ∑ÂâçÂæÄ‰∏ãÈù¢ÁöÑ URL Êü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØÂØπbodyËøõË°å‰øÆÊîπÂπ∂ËØ∑ÈáçÊñ∞Ëß¶ÂèëÁºñËØë(Close & Reopen).  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----
            PS:  
            Âú®Issues‰∏ãËØÑËÆ∫ "delete builds" Âç≥ÂèØÂà†ËØ•IssuesÁöÑÊâÄÊúâÂéÜÂè≤ÁºñËØëËÆ∞ÂΩï.
            >  
            ----  
          emoji: confused

      - name: Update Comment Warinfo
        if: env.issues == 'true' && env.warinfo != ''
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: append
          body: |
            >
            ----
            ‚ÄºÔ∏è‚ÄºÔ∏è‚ÄºÔ∏è  
            `Body ‰∏≠Âê´ÊúâËá™ÂÆö‰πâÁöÑ ${{ env.warinfo }} ÊïèÊÑü‰ø°ÊÅØ, ‰∏∫Èò≤Ê≠¢ÂÖ∂‰ªñ‰∫∫ÁõóÁî®, Âª∫ËÆÆÈôÑ‰ª∂‰∏ãËΩΩÂÆåÊàê/Á°ÆËÆ§ÈîôËØØÂéüÂõ†ÂêéÂà†Èô§Êó•ÂøóÂíåÈôÑ‰ª∂.`
            `Âú®Issues‰∏ãËØÑËÆ∫ "delete builds" Âç≥ÂèØÂà†IssuesÁöÑÊâÄÊúâÂéÜÂè≤ÁºñËØëËÆ∞ÂΩï.`  
            >
            ----
          emoji: eyes
